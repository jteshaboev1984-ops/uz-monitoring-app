<!DOCTYPE html>
<html lang="uz">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Ijtimoiy ahamiyatga mahsulotlar narxi monitoringi</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
    body {
      background: #f9fbfd;
      color: #222;
      padding: 16px;
      max-width: 600px;
      margin: 0 auto;
      padding-top: 100px;
      padding-bottom: 100px;
      position: relative;
    }
    .language-buttons {
      text-align: center;
      margin: 24px 0;
    }
    .language-buttons button {
      margin: 0 8px;
      padding: 8px 16px;
      border: 1px solid #ccc;
      border-radius: 20px;
      background: white;
      cursor: pointer;
      white-space: nowrap;
    }
    .language-buttons button.active {
      background: #1a73e8;
      color: white;
    }
    .top-bar {
      position: fixed;
      top: 12px;
      left: 16px;
      right: 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      z-index: 1000;
    }
    .dropdown {
      padding: 6px 12px;
      font-size: 13px;
      border: 1px solid #ccc;
      border-radius: 18px;
      background: white;
      cursor: pointer;
      min-width: auto;
      text-align: left;
      white-space: nowrap;
    }
    #restoreSelect {
      min-width: fit-content;
      width: auto;
    }
    h1 {
      font-size: 22px;
      text-align: center;
      margin: 0 0 30px;
    }
    .info-box {
      background: #e8f0fe;
      border-left: 4px solid #1a73e8;
      padding: 16px;
      border-radius: 8px;
      margin: 0 0 24px;
      font-size: 14px;
      line-height: 1.5;
      text-align: left;
    }
    .product {
      background: white;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
      transition: opacity 0.4s ease, transform 0.4s ease;
      text-align: left;
    }
    .product.hiding {
      opacity: 0;
      transform: translateY(-20px);
    }
    .product.hidden {
      display: none;
    }
    .product h2 {
      font-size: 16px;
      margin-bottom: 12px;
      color: #1a73e8;
      text-align: left;
    }
    .price-entry {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }
    .price-entry input {
      width: 80px;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 6px;
      text-align: center;
    }
    .quality-group {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    .quality-group label {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 14px;
      white-space: nowrap;
    }
    .submit-product-btn {
      width: 100%;
      padding: 10px;
      background: #1a73e8;
      color: white;
      border: none;
      border-radius: 8px;
      margin-top: 12px;
      cursor: pointer;
      font-weight: 500;
      white-space: nowrap;
      text-align: center;
    }
    .submit-product-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    #checkoutBtn, #checkinBtn {
      width: 100%;
      padding: 14px;
      border: none;
      border-radius: 10px;
      font-weight: 600;
      margin: 20px 0;
      font-size: 16px;
      white-space: nowrap;
    }
    #checkinBtn { background: #34a853; color: white; }
    #checkoutBtn { background: #fbbc05; color: #222; display: none; }

    .message, #confirmDialog {
      text-align: center;
      padding: 24px;
      background: white;
      border-radius: 12px;
      margin: 20px 0;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      display: none;
      white-space: normal;
    }
    .confirm-btns {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-top: 20px;
    }
    .confirm-btn {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      font-weight: bold;
      cursor: pointer;
      white-space: nowrap;
    }
    .confirm-yes { background: #34a853; color: white; }
    .confirm-no { background: #ea4335; color: white; }

    .disclaimer {
      font-size: 12px;
      color: #888;
      margin-top: 24px;
      text-align: center;
    }

    #emergencyBtn {
      position: fixed;
      bottom: 16px;
      left: 16px;
      right: 16px;
      padding: 16px;
      background: #d93025;
      color: white;
      border: none;
      border-radius: 12px;
      font-weight: bold;
      font-size: 16px;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(217, 48, 37, 0.4);
      z-index: 1000;
      white-space: nowrap;
    }

    #emergencyOverlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(217, 48, 37, 0.95);
      color: white;
      display: none;
      justify-content: center;
      align-items: center;
      text-align: center;
      z-index: 2000;
      padding: 20px;
      animation: pulse 1.2s infinite;
    }
    @keyframes pulse {
      0% { opacity: 0.7; }
      50% { opacity: 1; }
      100% { opacity: 0.7; }
    }
    #emergencyOverlay h2 {
      font-size: 24px;
      margin-bottom: 16px;
    }
    #emergencyOverlay p {
      font-size: 18px;
      line-height: 1.5;
    }
  </style>
</head>
<body>
  <div class="language-buttons" id="langButtons">
    <button data-lang="uz" class="active">O'zbekcha</button>
    <button data-lang="ru">–†—É—Å—Å–∫–∏–π</button>
    <button data-lang="en">English</button>
  </div>

  <div class="top-bar" id="topBar" style="display: none;">
    <select id="restoreSelect" class="dropdown">
      <option value="">üîÑ Ma'lumot yuborilgan mahsulotlar</option>
    </select>
    <select id="langSelect" class="dropdown">
      <option value="uz">O'zbekcha</option>
      <option value="ru">–†—É—Å—Å–∫–∏–π</option>
      <option value="en">English</option>
    </select>
  </div>

  <h1 id="title">Ijtimoiy ahamiyatga mahsulotlar narxi monitoringi</h1>

  <div class="info-box" id="permissionsInfo">
    Ma‚Äôlumotlarni iloji boricha aniq yig‚Äòish uchun iltimos, Telegram sozlamalarida joylashuv va vaqt ma‚Äôlumotlariga ruxsat bering.<br>Bu loyiha xavfsizligi va ishonchliligini ta‚Äôminlaydi.
  </div>

  <button id="checkinBtn" class="checkin-btn">üìç Monitoringni boshlash</button>
  <div id="products-container"></div>
  <button id="checkoutBtn">‚úÖ Monitoringni yakunlash</button>

  <div id="message" class="message"></div>
  <div id="confirmDialog" class="message"></div>
  <p class="disclaimer" id="disclaimer">
    Ma‚Äôlumotlar ta‚Äôlim loyihasi doirasida yig‚Äòiladi va faqat axborot maqsadida ishlatiladi.<br>
    Loyiha O‚Äòzbekiston Respublikasi Iqtisodiyot va moliya vazirligi huzuridagi Tarmoq bozorlari va ishlab chiqarishda mehnat unumdorligi tadqiqotlari markazi tomonidan o'quvchi-volontyorlar yordamida amalga oshiriladi.
  </p>

  <button id="emergencyBtn">üö® Favqulodda vaziyat</button>

  <div id="emergencyOverlay">
    <div>
      <h2>üö® Favqulodda vaziyat!</h2>
      <p>Siz bilan tez orada regional koordinator bog‚Äòlanadi.<br>
         Zarurat bo‚Äòlsa, Milliy gvardiya yoki Ichki ishlar vazirligi xodimlariga murojaat qiling.
      </p>
    </div>
  </div>

  <script>
    // === GOOGLE APPS SCRIPT URL (NO TRAILING SPACES!) ===
    const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycby7_IoC3mIHbC_PhK1fvhxrGPmcD0zck1ZMWrj0PHx7eHkUMBsvcO7Zb-7TDUWpoKqd/exec";

    const PRODUCTS_UZ = [
      "Non (500g)", "Guruch (1kg)", "Kartoshka (1kg)", "Sariq piyoz (1kg)", "Go‚Äòsht (1kg)",
      "Sut (1L)", "Tuxum (10 dona)", "Shakar (1kg)", "O‚Äòsimlik moyi (1L)", "Un (1kg)",
      "Makaron (1kg)", "Tuz (1kg)", "Qora choy (100g)", "Sabzi (1kg)", "Karam (1kg)",
      "Olma (1kg)", "Banana (1kg)", "Baliq (1kg)", "Sharbat (1L)", "Piyoz (1kg)"
    ];
    const PRODUCTS_RU = [
      "–•–ª–µ–± (500–≥)", "–†–∏—Å (1–∫–≥)", "–ö–∞—Ä—Ç–æ—Ñ–µ–ª—å (1–∫–≥)", "–õ—É–∫ —Ä–µ–ø—á–∞—Ç—ã–π (1–∫–≥)", "–ú—è—Å–æ (1–∫–≥)",
      "–ú–æ–ª–æ–∫–æ (1–ª)", "–Ø–π—Ü–∞ (10 —à—Ç)", "–°–∞—Ö–∞—Ä (1–∫–≥)", "–†–∞—Å—Ç. –º–∞—Å–ª–æ (1–ª)", "–ú—É–∫–∞ (1–∫–≥)",
      "–ú–∞–∫–∞—Ä–æ–Ω—ã (1–∫–≥)", "–°–æ–ª—å (1–∫–≥)", "–ß–∞–π —á–µ—Ä–Ω—ã–π (100–≥)", "–ú–æ—Ä–∫–æ–≤—å (1–∫–≥)", "–ö–∞–ø—É—Å—Ç–∞ (1–∫–≥)",
      "–Ø–±–ª–æ–∫–∏ (1–∫–≥)", "–ë–∞–Ω–∞–Ω—ã (1–∫–≥)", "–†—ã–±–∞ (1–∫–≥)", "–°–æ–∫ (1–ª)", "–õ—É–∫ (1–∫–≥)"
    ];
    const PRODUCTS_EN = [
      "Bread (500g)", "Rice (1kg)", "Potato (1kg)", "Onion (1kg)", "Meat (1kg)",
      "Milk (1L)", "Eggs (10 pcs)", "Sugar (1kg)", "Vegetable oil (1L)", "Flour (1kg)",
      "Pasta (1kg)", "Salt (1kg)", "Black tea (100g)", "Carrot (1kg)", "Cabbage (1kg)",
      "Apples (1kg)", "Bananas (1kg)", "Fish (1kg)", "Juice (1L)", "Onion (1kg)"
    ];

    const LANGUAGES = {
      uz: {
        title: "Ijtimoiy ahamiyatga mahsulotlar narxi monitoringi",
        permissions: "Ma‚Äôlumotlarni iloji boricha aniq yig‚Äòish uchun iltimos, Telegram sozlamalarida joylashuv va vaqt ma‚Äôlumotlariga ruxsat bering.<br>Bu loyiha xavfsizligi va ishonchliligini ta‚Äôminlaydi.",
        checkin: "üìç Monitoringni boshlash",
        checkout: "‚úÖ Monitoringni yakunlash",
        submitProduct: "Ma‚Äôlumotni yuborish",
        incompleteWarning: "Siz hali barcha mahsulotlar bo‚Äòyicha ma‚Äôlumot kiritmadingiz.<br>Baribir monitoringni yakunlamoqchimisiz?",
        yes: "Ha",
        no: "Yo‚Äòq",
        pricePlaceholder: "Narx",
        qualityA: "A toifasi",
        qualityB: "B toifasi",
        qualityC: "C toifasi",
        thankyou: "Bugungi monitoring muvaffaqiyatli yakunlandi!<br><br>Sizning hissangiz loyiha muvaffaqiyatiga katta hissa qo‚Äòshmoqda.<br>Keyingi monitoringda ham ishtirok etishni unutmang!",
        emergencyAlert: "Siz bilan tez orada regional koordinator bog‚Äòlanadi.<br>Zarurat bo‚Äòlsa, Milliy gvardiya yoki Ichki ishlar vazirligi xodimlariga murojaat qiling.",
        disclaimer: "Ma‚Äôlumotlar ta‚Äôlim loyihasi doirasida yig‚Äòiladi va faqat axborot maqsadida ishlatiladi.<br>Loyiha O‚Äòzbekiston Respublikasi Iqtisodiyot va moliya vazirligi huzuridagi Tarmoq bozorlari va ishlab chiqarishda mehnat unumdorligi tadqiqotlari markazi tomonidan o'quvchi-volontyorlar yordamida amalga oshiriladi.",
        restoreLabel: "üîÑ Ma'lumot yuborilgan mahsulotlar",
        products: PRODUCTS_UZ
      },
      ru: {
        title: "–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Ü–µ–Ω –Ω–∞ —Å–æ—Ü–∏–∞–ª—å–Ω–æ –∑–Ω–∞—á–∏–º—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã",
        permissions: "–î–ª—è –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π —Ç–æ—á–Ω–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, —Ä–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏ –∏ –≤—Ä–µ–º–µ–Ω–∏ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö Telegram.<br>–≠—Ç–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –∏ –¥–æ—Å—Ç–æ–≤–µ—Ä–Ω–æ—Å—Ç–∏ –ø—Ä–æ–µ–∫—Ç–∞.",
        checkin: "üìç –ù–∞—á–∞–ª–æ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞",
        checkout: "‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞",
        submitProduct: "–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é",
        incompleteWarning: "–í—ã –µ—â—ë –Ω–µ –≤–≤–µ–ª–∏ –¥–∞–Ω–Ω—ã–µ –ø–æ –≤—Å–µ–º —Ç–æ–≤–∞—Ä–∞–º.<br>–ó–∞–≤–µ—Ä—à–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –≤ –ª—é–±–æ–º —Å–ª—É—á–∞–µ?",
        yes: "–î–∞",
        no: "–ù–µ—Ç",
        pricePlaceholder: "–¶–µ–Ω–∞",
        qualityA: "–ö–∞—Ç–µ–≥–æ—Ä–∏—è A",
        qualityB: "–ö–∞—Ç–µ–≥–æ—Ä–∏—è B",
        qualityC: "–ö–∞—Ç–µ–≥–æ—Ä–∏—è C",
        thankyou: "–°–µ–≥–æ–¥–Ω—è—à–Ω–∏–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à—ë–Ω!<br><br>–í–∞—à –≤–∫–ª–∞–¥ –∏–≥—Ä–∞–µ—Ç –≤–∞–∂–Ω—É—é —Ä–æ–ª—å –≤ —É—Å–ø–µ—Ö–µ –ø—Ä–æ–µ–∫—Ç–∞.<br>–ù–µ –∑–∞–±—É–¥—å—Ç–µ –ø—Ä–∏–Ω—è—Ç—å —É—á–∞—Å—Ç–∏–µ –∏ –Ω–∞ —Å–ª–µ–¥—É—é—â–µ–º –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–µ!",
        emergencyAlert: "–°–∫–æ—Ä–æ —Å –≤–∞–º–∏ —Å–≤—è–∂–µ—Ç—Å—è —Ä–µ–≥–∏–æ–Ω–∞–ª—å–Ω—ã–π –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–æ—Ä.<br>–í —Å–ª—É—á–∞–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –æ–±—Ä–∞—â–∞–π—Ç–µ—Å—å –∫ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º –ü–∞—Ç—Ä—É–ª—å–Ω–æ–π —Å–ª—É–∂–±—ã –ù–∞—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–π –≥–≤–∞—Ä–¥–∏–∏ –∏–ª–∏ –ú–í–î.",
        disclaimer: "–î–∞–Ω–Ω—ã–µ –Ω–æ—Å—è—Ç —Å–∏–≥–Ω–∞–ª—å–Ω—ã–π –∏ –æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω—ã–π —Ö–∞—Ä–∞–∫—Ç–µ—Ä.<br>–ü—Ä–æ–µ–∫—Ç –æ—Å—É—â–µ—Å—Ç–≤–ª—è–µ—Ç—Å—è –¶–µ–Ω—Ç—Ä–æ–º –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–π –æ—Ç—Ä–∞—Å–ª–µ–≤—ã—Ö —Ä—ã–Ω–∫–æ–≤ –∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ —Ç—Ä—É–¥–∞ –≤ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ –ø—Ä–∏ –ú–∏–Ω–∏—Å—Ç–µ—Ä—Å—Ç–≤–µ —ç–∫–æ–Ω–æ–º–∏–∫–∏ –∏ —Ñ–∏–Ω–∞–Ω—Å–æ–≤ –†–µ—Å–ø—É–±–ª–∏–∫–∏ –£–∑–±–µ–∫–∏—Å—Ç–∞–Ω —Å —É—á–∞—Å—Ç–∏–µ–º —É—á–µ–Ω–∏–∫–æ–≤-–≤–æ–ª–æ–Ω—Ç—ë—Ä–æ–≤.",
        restoreLabel: "üîÑ –ü—Ä–æ–¥—É–∫—Ç—ã —Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏",
        products: PRODUCTS_RU
      },
      en: {
        title: "Monitoring prices of socially significant products",
        permissions: "To ensure data accuracy, please allow access to location and time in Telegram settings.<br>This is essential for project security and reliability.",
        checkin: "üìç Start monitoring",
        checkout: "‚úÖ End monitoring",
        submitProduct: "Submit data",
        incompleteWarning: "You have not submitted data for all products yet.<br>Finish monitoring anyway?",
        yes: "Yes",
        no: "No",
        pricePlaceholder: "Price",
        qualityA: "Grade A",
        qualityB: "Grade B",
        qualityC: "Grade C",
        thankyou: "Today‚Äôs monitoring has been successfully completed!<br><br>Your contribution is vital to the project‚Äôs success.<br>Don‚Äôt forget to participate again in the next monitoring session!",
        emergencyAlert: "A regional coordinator will contact you shortly.<br>In case of emergency, contact the Patrol Service of the National Guard or Ministry of Internal Affairs.",
        disclaimer: "Data collected for educational purposes only.<br>The project is implemented by the Center for Market and Productivity Research, Ministry of Economy and Finance of the Republic of Uzbekistan, with the help of student volunteers.",
        restoreLabel: "üîÑ Products with submitted data",
        products: PRODUCTS_EN
      }
    };

    // === TELEGRAM INIT ===
    Telegram.WebApp.ready();
    Telegram.WebApp.expand();
    Telegram.WebApp.disableVerticalSwipes();
    const userData = Telegram.WebApp.initDataUnsafe?.user || {};
    const today = new Date().toISOString().split('T')[0];

    let currentLang = 'uz';
    let isCheckInDone = false;
    let checkInData = null;
    const submittedProducts = new Map();

    const langButtons = document.querySelectorAll('#langButtons button');
    const topBar = document.getElementById('topBar');
    const langSelect = document.getElementById('langSelect');
    const restoreSelect = document.getElementById('restoreSelect');
    const titleEl = document.getElementById('title');
    const checkinBtn = document.getElementById('checkinBtn');
    const checkoutBtn = document.getElementById('checkoutBtn');
    const container = document.getElementById('products-container');
    const messageEl = document.getElementById('message');
    const confirmDialog = document.getElementById('confirmDialog');
    const disclaimerEl = document.getElementById('disclaimer');
    const permissionsInfoEl = document.getElementById('permissionsInfo');
    const emergencyBtn = document.getElementById('emergencyBtn');
    const emergencyOverlay = document.getElementById('emergencyOverlay');

    function preserveScroll(fn) {
      const scrollY = window.scrollY;
      fn();
      window.scrollTo(0, scrollY);
    }

    langButtons.forEach(btn => {
      btn.addEventListener('click', (e) => {
        langButtons.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentLang = btn.dataset.lang;
        langSelect.value = currentLang;
        preserveScroll(updateUI);
      });
    });

    langSelect.addEventListener('change', (e) => {
      currentLang = langSelect.value;
      langButtons.forEach(b => b.classList.toggle('active', b.dataset.lang === currentLang));
      messageEl.style.display = 'none';
      confirmDialog.style.display = 'none';
      preserveScroll(updateUI);
    });

    function updateUI() {
      const t = LANGUAGES[currentLang];
      titleEl.textContent = t.title;
      permissionsInfoEl.innerHTML = t.permissions;
      checkinBtn.textContent = t.checkin;
      checkoutBtn.textContent = t.checkout;
      disclaimerEl.innerHTML = t.disclaimer;
      emergencyBtn.textContent = "üö® " + (currentLang === 'uz' ? "Favqulodda vaziyat" : currentLang === 'ru' ? "–ß—Ä–µ–∑–≤—ã—á–∞–π–Ω–∞—è —Å–∏—Ç—É–∞—Ü–∏—è" : "Emergency");
      restoreSelect.innerHTML = `<option value="">${t.restoreLabel}</option>`;
      updateRestoreDropdown();
      if (isCheckInDone) renderForm();
    }

    checkinBtn.addEventListener('click', () => {
      checkInData = {
        userId: userData.id,
        firstName: userData.first_name,
        lastName: userData.last_name,
        username: userData.username,
        checkInTime: new Date().toISOString(),
        date: today
      };

      document.getElementById('langButtons').style.display = 'none';
      topBar.style.display = 'flex';
      checkinBtn.style.display = 'none';
      permissionsInfoEl.style.display = 'none';
      checkoutBtn.style.display = 'block';
      isCheckInDone = true;
      renderForm();
    });

    function renderForm() {
      container.innerHTML = '';
      const products = LANGUAGES[currentLang].products;
      products.forEach((name) => {
        if (submittedProducts.has(name)) return;

        const productDiv = document.createElement('div');
        productDiv.className = 'product';
        productDiv.dataset.product = name;

        let entriesHTML = '';
        for (let i = 0; i < 5; i++) {
          entriesHTML += `
            <div class="price-entry">
              <input type="number" step="0.01" min="0" placeholder="${LANGUAGES[currentLang].pricePlaceholder}"
                data-product="${name}" data-index="${i}">
              <div class="quality-group">
                <label><input type="radio" name="q-${name}-${i}" value="A"> ${LANGUAGES[currentLang].qualityA}</label>
                <label><input type="radio" name="q-${name}-${i}" value="B"> ${LANGUAGES[currentLang].qualityB}</label>
                <label><input type="radio" name="q-${name}-${i}" value="C"> ${LANGUAGES[currentLang].qualityC}</label>
              </div>
            </div>
          `;
        }

        productDiv.innerHTML = `
          <h2>${name}</h2>
          ${entriesHTML}
          <button class="submit-product-btn" data-product="${name}">
            ${LANGUAGES[currentLang].submitProduct}
          </button>
        `;
        container.appendChild(productDiv);

        const inputs = productDiv.querySelectorAll('input[type="number"]');
        const radios = productDiv.querySelectorAll('input[type="radio"]');
        const submitBtn = productDiv.querySelector('.submit-product-btn');

        function validateProduct() {
          let valid = false;
          for (let i = 0; i < 5; i++) {
            const price = parseFloat(productDiv.querySelector(`input[data-index="${i}"]`).value) || null;
            const radio = productDiv.querySelector(`input[name="q-${name}-${i}"]:checked`);
            if (price !== null && radio) valid = true;
          }
          submitBtn.disabled = !valid;
        }

        inputs.forEach(inp => inp.addEventListener('input', validateProduct));
        radios.forEach(r => r.addEventListener('change', validateProduct));

        submitBtn.addEventListener('click', () => {
          const entries = [];
          for (let i = 0; i < 5; i++) {
            const price = parseFloat(productDiv.querySelector(`input[data-index="${i}"]`).value) || null;
            const radio = productDiv.querySelector(`input[name="q-${name}-${i}"]:checked`);
            if (price !== null && radio) {
              entries.push({ price, quality: radio.value });
            }
          }
          if (entries.length === 0) return;

          const payload = {
            ...checkInData,
            product: name,
            entries,
            submitTime: new Date().toISOString(),
            platform: "Telegram Mini App"
          };

          // ‚úÖ SEND VIA FORMDATA (NO CORS ISSUES)
          const formData = new FormData();
          formData.append('payload', JSON.stringify(payload));
          fetch(GOOGLE_SCRIPT_URL, {
            method: 'POST',
            body: formData
          })
          .then(() => {
            submittedProducts.set(name, { entries, dom: productDiv });
            productDiv.classList.add('hiding');
            setTimeout(() => {
              productDiv.classList.add('hidden');
              updateRestoreDropdown();
            }, 400);
          })
          .catch((error) => {
            console.error("Send error:", error);
            Telegram.WebApp.showAlert("Ma'lumot yuborishda xatolik yuz berdi!");
          });
        });
      });
    }

    function updateRestoreDropdown() {
      const t = LANGUAGES[currentLang];
      restoreSelect.innerHTML = `<option value="">${t.restoreLabel}</option>`;
      submittedProducts.forEach((_, name) => {
        const opt = document.createElement('option');
        opt.value = name;
        opt.textContent = name;
        restoreSelect.appendChild(opt);
      });
      restoreSelect.onchange = (e) => {
        const name = e.target.value;
        if (name) {
          const rec = submittedProducts.get(name);
          if (rec && rec.dom) {
            rec.dom.classList.remove('hidden', 'hiding');
            submittedProducts.delete(name);
          }
          e.target.value = "";
          updateRestoreDropdown();
        }
      };
    }

    checkoutBtn.addEventListener('click', () => {
      if (submittedProducts.size < LANGUAGES[currentLang].products.length) {
        const t = LANGUAGES[currentLang];
        confirmDialog.innerHTML = `
          <p>${t.incompleteWarning}</p>
          <div class="confirm-btns">
            <button class="confirm-btn confirm-yes">${t.yes}</button>
            <button class="confirm-btn confirm-no">${t.no}</button>
          </div>
        `;
        confirmDialog.style.display = 'block';

        confirmDialog.querySelector('.confirm-yes').onclick = () => {
          const alertPayload = {
            type: "INCOMPLETE_CHECKOUT",
            userId: checkInData.userId,
            timestamp: new Date().toISOString(),
            submitted: submittedProducts.size,
            total: LANGUAGES[currentLang].products.length
          };
          const formData = new FormData();
          formData.append('payload', JSON.stringify(alertPayload));
          fetch(GOOGLE_SCRIPT_URL, { method: 'POST', body: formData });
          confirmDialog.style.display = 'none';
          finalizeCheckout();
        };
        confirmDialog.querySelector('.confirm-no').onclick = () => {
          confirmDialog.style.display = 'none';
        };
      } else {
        finalizeCheckout();
      }
    });

    function finalizeCheckout() {
      const t = LANGUAGES[currentLang];
      messageEl.innerHTML = t.thankyou;
      messageEl.style.display = 'block';
      setTimeout(() => resetApp(), 20000);
    }

    function resetApp() {
      isCheckInDone = false;
      checkInData = null;
      submittedProducts.clear();
      document.getElementById('langButtons').style.display = 'block';
      topBar.style.display = 'none';
      checkinBtn.style.display = 'block';
      permissionsInfoEl.style.display = 'block';
      checkoutBtn.style.display = 'none';
      messageEl.style.display = 'none';
      confirmDialog.style.display = 'none';
      container.innerHTML = '';
    }

    emergencyBtn.addEventListener('click', () => {
      const emergencyPayload = {
        type: "EMERGENCY_ALERT",
        userId: userData.id,
        timestamp: new Date().toISOString()
      };
      const formData = new FormData();
      formData.append('payload', JSON.stringify(emergencyPayload));
      fetch(GOOGLE_SCRIPT_URL, { method: 'POST', body: formData });
      emergencyOverlay.style.display = 'flex';
      setTimeout(() => {
        emergencyOverlay.style.display = 'none';
        resetApp();
      }, 10000);
    });

    updateUI();
  </script>
</body>
</html>


