<!DOCTYPE html>
<html lang="uz">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Ijtimoiy ahamiyatga mahsulotlar narxi monitoringi</title>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background-color: var(--tg-theme-bg-color, #fff);
      color: var(--tg-theme-text-color, #000);
      margin: 0;
      padding: 15px;
    }
    h1 { font-size: 20px; text-align: center; margin-bottom: 20px; }
    button {
      width: 100%;
      padding: 15px;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      background-color: var(--tg-theme-button-color, #3390ec);
      color: var(--tg-theme-button-text-color, #fff);
      margin-bottom: 10px;
    }
    button:disabled { opacity: 0.6; cursor: not-allowed; }
    input {
      width: 100%;
      padding: 12px;
      border: 1px solid #ccc;
      border-radius: 8px;
      font-size: 16px;
      margin-bottom: 10px;
      background-color: var(--tg-theme-secondary-bg-color, #f0f0f0);
    }
    .product {
      background: var(--tg-theme-secondary-bg-color, #f4f4f5);
      padding: 15px;
      border-radius: 12px;
      margin-bottom: 15px;
    }
    .hidden { display: none !important; }
    .dropdown {
      width: 100%;
      padding: 10px;
      margin-bottom: 15px;
      border-radius: 8px;
      font-size: 16px;
    }
    .language-buttons {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      justify-content: center;
    }
    .language-buttons button {
      width: auto;
      padding: 8px 16px;
      font-size: 14px;
      background-color: #e0e0e0;
      color: #333;
    }
    .language-buttons button.active {
      background-color: var(--tg-theme-button-color, #3390ec);
      color: white;
    }
  </style>
</head>

<body>

<div class="language-buttons" id="langButtons">
  <button data-lang="uz" onclick="setLang('uz')" id="btn-uz" class="active">O'zbekcha</button>
  <button data-lang="ru" onclick="setLang('ru')" id="btn-ru">–†—É—Å—Å–∫–∏–π</button>
  <button data-lang="en" onclick="setLang('en')" id="btn-en">English</button>
</div>

<div class="top-bar" id="topBar" style="display:none;">
  <select id="restoreSelect" class="dropdown"></select>
</div>

<h1 id="title">Monitoring</h1>

<button id="checkinBtn">üìç Monitoringni boshlash</button>
<div id="products-container"></div>
<button id="checkoutBtn" style="display:none;">‚úÖ Monitoringni yakunlash</button>

<script>
/* ================= CONFIG ================= */

const GOOGLE_SCRIPT_URL =
"https://script.google.com/macros/s/AKfycbzcx36HPEDsXkg4CyAg3U3Rxtr64krgkjiH8vcKltd_H4he3eZ7nfVgYRi0OABfUfDZ/exec";

/* ================= DATA ================= */

const PRODUCTS_UZ = [
  "Non (500g)","Guruch (1kg)","Shakar (1kg)","Yog' (1L)","Kartoshka (1kg)",
  "Piyoz (1kg)","Go'sht (mol, 1kg)","Tuxum (10 dona)","Sut (1L)","Udon (1kg)",
  "Sabzi (1kg)","Qaymoq (200g)","Pishloq (100g)","Choy (100g)","Qahva (100g)",
  "Makaron (500g)","Baliq (1kg)","Mevalar (1kg)","Poliz ekinlari (1kg)","Asal (250g)"
];

const PRODUCTS_RU = [
  "–•–ª–µ–± (500–≥)","–†–∏—Å (1–∫–≥)","–°–∞—Ö–∞—Ä (1–∫–≥)","–ú–∞—Å–ª–æ —Ä–∞—Å—Ç–∏—Ç–µ–ª—å–Ω–æ–µ (1–ª)","–ö–∞—Ä—Ç–æ—Ñ–µ–ª—å (1–∫–≥)",
  "–õ—É–∫ (1–∫–≥)","–ú—è—Å–æ (–≥–æ–≤—è–¥–∏–Ω–∞, 1–∫–≥)","–Ø–π—Ü–∞ (10 —à—Ç)","–ú–æ–ª–æ–∫–æ (1–ª)","–ú—É–∫–∞ (1–∫–≥)",
  "–ú–æ—Ä–∫–æ–≤—å (1–∫–≥)","–°–º–µ—Ç–∞–Ω–∞ (200–≥)","–°—ã—Ä (100–≥)","–ß–∞–π (100–≥)","–ö–æ—Ñ–µ (100–≥)",
  "–ú–∞–∫–∞—Ä–æ–Ω—ã (500–≥)","–†—ã–±–∞ (1–∫–≥)","–§—Ä—É–∫—Ç—ã (1–∫–≥)","–ë–∞—Ö—á–µ–≤—ã–µ (1–∫–≥)","–ú—ë–¥ (250–≥)"
];

const PRODUCTS_EN = [
  "Bread (500g)","Rice (1kg)","Sugar (1kg)","Oil (1L)","Potatoes (1kg)",
  "Onion (1kg)","Meat (beef, 1kg)","Eggs (10 pcs)","Milk (1L)","Flour (1kg)",
  "Carrot (1kg)","Sour cream (200g)","Cheese (100g)","Tea (100g)","Coffee (100g)",
  "Pasta (500g)","Fish (1kg)","Fruits (1kg)","Melon crops (1kg)","Honey (250g)"
];

const LANGUAGES = {
  uz:{title:"Monitoring",checkin:"Boshlash",checkout:"Yakunlash",submitProduct:"Yuborish",restoreLabel:"üîÑ Yuborilganlar",products:PRODUCTS_UZ,sending:"Yuborilmoqda..."},
  ru:{title:"–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥",checkin:"–ù–∞—á–∞—Ç—å",checkout:"–ó–∞–≤–µ—Ä—à–∏—Ç—å",submitProduct:"–û—Ç–ø—Ä–∞–≤–∏—Ç—å",restoreLabel:"üîÑ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ",products:PRODUCTS_RU,sending:"–û—Ç–ø—Ä–∞–≤–∫–∞..."},
  en:{title:"Monitoring",checkin:"Start",checkout:"Finish",submitProduct:"Submit",restoreLabel:"üîÑ Submitted",products:PRODUCTS_EN,sending:"Sending..."}
};

/* ================= TELEGRAM ================= */

const tg = window.Telegram.WebApp;
tg.expand();
const user = tg.initDataUnsafe?.user || {};
const userID = user.id || "no_id";
const username = user.username || user.first_name || "Anonymous";

/* ================= STATE ================= */

let currentLang = "uz";
let isCheckInDone = false;
let submittedProducts = new Map();
let userLocation = { lat:"", lon:"" };

/* ================= ELEMENTS ================= */

const container = document.getElementById("products-container");
const restoreSelect = document.getElementById("restoreSelect");
const titleEl = document.getElementById("title");
const checkinBtn = document.getElementById("checkinBtn");
const checkoutBtn = document.getElementById("checkoutBtn");
const langButtons = document.getElementById("langButtons");

/* ================= UI ================= */

function setLang(lang){
  currentLang = lang;
  langButtons.querySelectorAll("button").forEach(b=>b.classList.remove("active"));
  document.getElementById("btn-"+lang).classList.add("active");
  updateUI();
  if(isCheckInDone) renderForm();
}

function updateUI(){
  const t = LANGUAGES[currentLang];
  titleEl.textContent = t.title;
  checkinBtn.textContent = t.checkin;
  checkoutBtn.textContent = t.checkout;
  updateRestoreDropdown();
}

function updateRestoreDropdown(){
  const t = LANGUAGES[currentLang];
  restoreSelect.innerHTML = `<option value="">${t.restoreLabel} (${submittedProducts.size})</option>`;
  submittedProducts.forEach((v,name)=>{
    const opt=document.createElement("option");
    opt.value=name;
    opt.textContent=name+" ‚úÖ";
    restoreSelect.appendChild(opt);
  });
  restoreSelect.onchange=e=>{
    const name=e.target.value;
    if(!name)return;
    const rec=submittedProducts.get(name);
    if(rec){rec.dom.classList.remove("hidden");submittedProducts.delete(name);}
    e.target.value="";
    updateRestoreDropdown();
  };
}

function renderForm(){
  container.innerHTML="";
  const t=LANGUAGES[currentLang];
  t.products.forEach(name=>{
    if(submittedProducts.has(name))return;
    const div=document.createElement("div");
    div.className="product";
    div.innerHTML=`<h3>${name}</h3><input type="number"><button>${t.submitProduct}</button>`;
    const btn=div.querySelector("button");
    const input=div.querySelector("input");
    btn.disabled=true;
    input.oninput=()=>btn.disabled=!input.value.trim();
    btn.onclick=()=>{
      const price=input.value.trim();
      if(!price)return;
      const old=btn.textContent;
      btn.textContent=t.sending;
      btn.disabled=true;
      sendDataToGoogle(name,price,div,btn,old);
    };
    container.appendChild(div);
  });
}

function sendDataToGoogle(product,price,div,btn,oldText){
  const data={user_id:userID,username,product,price,lat:userLocation.lat,lon:userLocation.lon};
  const fd=new FormData();
  fd.append("payload",JSON.stringify(data));
  fetch(GOOGLE_SCRIPT_URL,{method:"POST",body:fd})
  .then(()=>{
    submittedProducts.set(product,{dom:div});
    div.classList.add("hidden");
    updateRestoreDropdown();
  })
  .catch(()=>{
    if(tg.showAlert){tg.showAlert("–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö!");}
    else{alert("–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö!");}
    btn.textContent=oldText;
    btn.disabled=false;
  });
}

checkinBtn.onclick=()=>{
  if(navigator.geolocation){
    navigator.geolocation.getCurrentPosition(p=>{
      userLocation.lat=p.coords.latitude;
      userLocation.lon=p.coords.longitude;
    });
  }
  isCheckInDone=true;
  checkinBtn.style.display="none";
  checkoutBtn.style.display="block";
  document.getElementById("topBar").style.display="block";
  renderForm();
};

checkoutBtn.onclick=()=>tg.close();
updateUI();
</script>

</body>
</html>
